@model List<Message>
@{
    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var chatUser = ViewBag.ChatUser;
}


<div class="chat-container">
    <div class="chat-header">
        <button id="toggleSelectModeBtn" class="btn btn-outline-primary">Select</button>
        <div id="bulkActions" style="display:none;">
            <button id="deleteSelectedMe" class="btn btn-danger">Delete for Me</button>
            <button id="deleteSelectedAll" class="btn btn-danger" style="display:none;">Delete for Everyone</button>
            <button id="cancelSelectBtn" class="btn btn-secondary">Cancel</button>
        </div>


        <input type="hidden" id="senderId" value="@currentUserId" />
        <input type="hidden" id="receiverId" value="@chatUser.Id" />

        <div class="profile">
            <img src="@chatUser.ProfilePicture" alt="Profile Picture" class="profile-img" />
            @{
                DateTime lastSeen = Convert.ToDateTime(chatUser.LastSeen);
                string lastSeenText = "Last seen unknown";

                 
                var diff = DateTime.UtcNow - lastSeen;

                if (diff.TotalSeconds < 1)   
                {
                    lastSeenText = "Online now";
                }
                else if (diff.TotalMinutes < 5)
                {
                    lastSeenText = $"Last seen {Math.Floor(diff.TotalMinutes)} minutes ago";
                }
                else if (diff.TotalDays < 1)
                {
                    lastSeenText = $"Last seen today at {lastSeen.ToLocalTime():HH:mm}";
                }
                else
                {
                    lastSeenText = $"Last seen on {lastSeen.ToLocalTime():yyyy-MM-dd HH:mm}";
                }
            }

            <div class="d-flex flex-column">
                <h4>@chatUser.FirstName @chatUser.LastName</h4>
                <small class="">@lastSeenText</small>
            </div>

        </div>
    </div>

    <div id="messagesContainer" class="chat-messages">
        @foreach (var message in Model)
        {
            <div class="message @(message.SenderId == currentUserId ? "sent" : "received")"
                 data-id="@message.Id"
                 data-sender-id="@message.SenderId">
                <input type="checkbox" class="message-select-checkbox" style="display:none;" />
                <div class="message-header">
                  
                    <div class="dropdown message-options">
                        <button class="dots-btn text-black" data-bs-toggle="dropdown" aria-expanded="false">⋮</button>
                        <ul class="dropdown-menu">
                            @if (message.SenderId == currentUserId)
                            {
                                <li><a class="dropdown-item edit-message" data-id="@message.Id" href="#">Edit</a></li>
                                <li><a class="dropdown-item delete-message" data-id="@message.Id" data-scope="me" href="#">Delete for me</a></li>
                                <li><a class="dropdown-item delete-message" data-id="@message.Id" data-scope="all" href="#">Delete for everyone</a></li>
                                <li><a class="dropdown-item info-message" data-id="@message.Id" href="#">Info</a></li>
                            }
                            else
                            {
                                <li><a class="dropdown-item delete-message" data-id="@message.Id" data-scope="me" href="#">Delete for me</a></li>
                            }
                        </ul>


                    </div>
                   
                </div>
                <p>@message.Content</p>
                <small>
                    @message.SentAt.ToLocalTime().ToString("HH:mm")
                    @if (message.SenderId == currentUserId && message.IsRead)
                    {
                        <span title="Read">✅</span>
                    }
                </small>
            </div>
        }
    </div>



    <div class="chat-input">
        <textarea type="text" id="messageInput" placeholder="Write a message..." required></textarea>
        <button type="button" id="emojiBtn">😊</button>
        <button id="sendButton" aria-label="Send message">
            <svg xmlns="http://www.w3.org/2000/svg" fill="white" width="20" height="20" viewBox="0 0 24 24">
                <path d="M2 21l21-9L2 3v7l15 2-15 2v7z" />
            </svg>
        </button>
    </div>
</div>


<div class="modal fade" id="editMessageModal" tabindex="-1" aria-labelledby="editMessageLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMessageLabel">Edit Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="editMessageInput" class="form-control" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">UnSave</button>
                <button type="button" id="saveEditBtn" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>


<div id="messageInfoBox" class="alert alert-info position-relative" style="margin-top: 20px;">
    <button type="button" class="btn-close position-absolute top-0 end-0 m-2" id="closeInfoBox" aria-label="close"></button>
    <div id="infoContent"></div>
</div>


<link rel="stylesheet" href="~/css/Chat.css" />

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>

    <script>

        var connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub")
            .build();


        connection.start().then(function () {
            console.log("Connected to SignalR Hub!");
        }).catch(function (err) {
            console.error("SignalR connection failed: " + err.toString());
        });



             connection.on("ReceiveMessage", function (sender, message, messageId, sentAt, isRead) {
            var messageContainer = document.getElementById("messagesContainer");
            var messageElement = document.createElement("div");

            var currentUserId = document.getElementById("senderId").value;

            var isSent = sender === currentUserId;

            messageElement.classList.add("message");
            messageElement.classList.add(isSent ? "sent" : "received");

             
            messageElement.setAttribute('data-id', messageId);
            messageElement.setAttribute('data-sender-id', sender);
                     messageElement.innerHTML = `
                                     <input type="checkbox" class="message-select-checkbox" style="display:none;" />
            <div class="message-header">
                <div class="dropdown message-options">
                    <button class="dots-btn text-black" data-bs-toggle="dropdown" aria-expanded="false">⋮</button>
                    <ul class="dropdown-menu" style="direction: rtl;">
                        ${isSent ? `
                            <li><a class="dropdown-item edit-message" data-id="${messageId}" href="#">Edit</a></li>
                            <li><a class="dropdown-item delete-message" data-id="${messageId}" data-scope="me" href="#">Delete for me</a></li>
                            <li><a class="dropdown-item delete-message" data-id="${messageId}" data-scope="all" href="#">Delete for everyone</a></li>
                            <li><a class="dropdown-item info-message" data-id="${messageId}" href="#">Info</a></li>
                        ` : `
                            <li><a class="dropdown-item delete-message" data-id="${messageId}" data-scope="me" href="#">Delete for me</a></li>
                        `}
                    </ul>
                </div>
            </div>
            <p>${message}</p>
            <small>
                ${new Date(sentAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                ${isSent && isRead ? '<span title="Read">✅</span>' : ''}
            </small>
        `;


        messageContainer.appendChild(messageElement);
        bootstrap.Dropdown.getOrCreateInstance(messageElement.querySelector('[data-bs-toggle="dropdown"]'));
        messageContainer.scrollTop = messageContainer.scrollHeight;

        });


           document.getElementById("sendButton").addEventListener("click", function () {
               var sender = document.getElementById("senderId").value.trim();  
        var receiver = document.getElementById("receiverId").value.trim();
        var messageContent = document.getElementById("messageInput").value.trim();

            if (!messageContent || !sender || !receiver) {
                alert("Please provide Sender, Receiver, and Message.");
                return;
            }

           connection.invoke("SendMessage", sender, receiver, messageContent)
        .catch(err => console.error(err));

            document.getElementById("messageInput").value = "";
        });
    </script>


    <!-- مكتبة الإيموجي الجاهزة -->
    <script src="https://unpkg.com/picmo@latest/dist/umd/index.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/picmo@latest/dist/styles.css">
    <script type="module">
        import 'https://cdn.jsdelivr.net/npm/emoji-picker-element@@^1/index.js';

        document.addEventListener('DOMContentLoaded', () => {
          const picker = document.createElement('emoji-picker');
          picker.style.position = 'absolute';
          picker.style.bottom = '60px';
          picker.style.right = '20px';
          picker.style.zIndex = '1000';
          picker.style.display = 'none';

          document.body.appendChild(picker);

          const input = document.querySelector('#messageInput');
          const emojiBtn = document.querySelector('#emojiBtn');

          emojiBtn.addEventListener('click', () => {
            picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
          });

          picker.addEventListener('emoji-click', event => {
            const emoji = event.detail.unicode;
            const start = input.selectionStart;
            const end = input.selectionEnd;
            input.value = input.value.slice(0, start) + emoji + input.value.slice(end);
            input.focus();
            input.selectionStart = input.selectionEnd = start + emoji.length;
           
          });

          
          document.addEventListener('click', (e) => {
            if (!picker.contains(e.target) && e.target !== emojiBtn) {
              picker.style.display = 'none';
            }
          });
        });





    </script>

    <script>

        let editingMessageId = null;

                          $(document).on('click', '.delete-message', function (e) {
            e.preventDefault();
            const messageId = $(this).data('id');
            const deleteScope = $(this).data('scope'); 
            const messageElement = $(this).closest('.message');

            let confirmText = deleteScope === "all"
                ? "Are you sure you want to delete this message for everyone?"
                : "Are you sure you want to delete this message for yourself only?";

            if (confirm(confirmText)) {
                $.post('/ContentCreator/Messages/DeleteMessage', { id: messageId, scope: deleteScope }, function () {
                    messageElement.remove();
                });
            }
        });



         $(document).on('click', '.edit-message', function (e) {
             e.preventDefault();
             const messageId = $(this).data('id');
             const messageElement = $(this).closest('.message');
             const originalContent = messageElement.find('p').text();

             $('#editMessageInput').val(originalContent);
             editingMessageId = messageId;

             const modal = new bootstrap.Modal(document.getElementById('editMessageModal'));
             modal.show();
         });

           $(document).on('click', '#saveEditBtn', function () {
            const newContent = $('#editMessageInput').val();

            if (!newContent.trim()) {
                alert('The message cannot be empty.');
                return;
            }

            $.post('/ContentCreator/Messages/EditMessage', {
                id: editingMessageId,
                content: newContent
            }, function () {

                const messageElement = $(`.message[data-id="${editingMessageId}"]`);
                messageElement.find('p').text(newContent);


                const modal = bootstrap.Modal.getInstance(document.getElementById('editMessageModal'));
                modal.hide();


                editingMessageId = null;
            });
        });

                $(document).on('click', '.info-message', function (e) {
            e.preventDefault();
            const messageId = $(this).data('id');

            $.get('/ContentCreator/Messages/MessageInfo', { id: messageId }, function (data) {
                $('#infoContent').html(
                    `<strong>Sent:</strong> ${data.sentAt}<br>
                     <strong>State:</strong> ${data.isRead ? `✔️ Read<br><strong>Read At:</strong> ${data.readAt}` : '📭 Unread'}`
                );

                const box = $('#messageInfoBox');
                box.stop(true, true).fadeIn(300);

                setTimeout(() => {
                    box.fadeOut(300);
                }, 3000);
            });
        });


        $('#closeInfoBox').on('click', function () {
            $('#messageInfoBox').fadeOut(300);
        });
    </script>
    <script>
                let selectMode = false;
        const toggleSelectModeBtn = document.getElementById('toggleSelectModeBtn');
        const bulkActions = document.getElementById('bulkActions');
        const messagesContainer = document.getElementById('messagesContainer');

        toggleSelectModeBtn.addEventListener('click', () => {
            selectMode = !selectMode;
            if (selectMode) {
                document.body.classList.add('select-mode');
                bulkActions.style.display = 'block';
                toggleSelectModeBtn.style.display = 'none';

                document.querySelectorAll('.message').forEach(msg => {
                    const checkbox = msg.querySelector('.message-select-checkbox');
                    if (checkbox) checkbox.style.display = 'inline-block';

                    
                    const dotsBtn = msg.querySelector('.dots-btn');
                    if (dotsBtn) dotsBtn.style.display = 'none';
                });
            } else {
                cancelSelection();
            }
        });


        function cancelSelection() {
            selectMode = false;
            document.body.classList.remove('select-mode');
            bulkActions.style.display = 'none';
            toggleSelectModeBtn.style.display = 'inline-block';
           
            document.querySelectorAll('.message').forEach(msg => {
                const checkbox = msg.querySelector('.message-select-checkbox');
                if (checkbox) {
                    checkbox.checked = false;
                    checkbox.style.display = 'none';
                }
                msg.classList.remove('selected');
                const dotsBtn = msg.querySelector('.dots-btn');
                if (dotsBtn) dotsBtn.style.display = 'inline-block';
            });
        }

        
        document.getElementById('cancelSelectBtn').addEventListener('click', cancelSelection);

        messagesContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('message-select-checkbox')) {
                const msgDiv = e.target.closest('.message');
                if (e.target.checked) {
                    msgDiv.classList.add('selected');
                } else {
                    msgDiv.classList.remove('selected');
                }
                updateBulkActionsUI(); 
            }
        });


               
        document.getElementById('deleteSelectedMe').addEventListener('click', () => {
            const selectedIds = Array.from(document.querySelectorAll('.message-select-checkbox:checked'))
                .map(cb => cb.closest('.message').getAttribute('data-id'));

            if (selectedIds.length === 0) return;

            if (confirm("Are you sure you want to delete selected messages for you?")) {
                $.ajax({
                    url: '/ContentCreator/Messages/DeleteMultipleMessagesForMe',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(selectedIds),
                    success: () => {
                        selectedIds.forEach(id => document.querySelector(`.message[data-id="${id}"]`).remove());
                        cancelSelection();
                    }
                });
            }
        });

                
        document.getElementById('deleteSelectedAll').addEventListener('click', () => {
            const selectedIds = Array.from(document.querySelectorAll('.message-select-checkbox:checked'))
                .map(cb => cb.closest('.message').getAttribute('data-id'));

            if (selectedIds.length === 0) return;

            if (confirm("Are you sure you want to delete selected messages for everyone?")) {
                $.ajax({
                    url: '/ContentCreator/Messages/DeleteMultipleMessagesForAll',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(selectedIds),
                    success: () => {
                        selectedIds.forEach(id => document.querySelector(`.message[data-id="${id}"]`).remove());
                        cancelSelection();
                    }
                });
            }
        });
                function updateBulkActionsUI() {
            const currentUserId = document.getElementById('senderId').value;
            const selectedMessages = Array.from(document.querySelectorAll('.message-select-checkbox:checked'))
                .map(cb => cb.closest('.message'));

            if (selectedMessages.length === 0) {
                document.getElementById('deleteSelectedMe').style.display = 'none';
                document.getElementById('deleteSelectedAll').style.display = 'none';
                return;
            }

            
            let allFromMe = selectedMessages.every(msg => msg.dataset.senderId === currentUserId);
            let allFromOther = selectedMessages.every(msg => msg.dataset.senderId !== currentUserId);

           
            document.getElementById('deleteSelectedMe').style.display = 'inline-block';
            if (allFromMe) {
                document.getElementById('deleteSelectedAll').style.display = 'inline-block';
            } else {
                document.getElementById('deleteSelectedAll').style.display = 'none';
            }
        }

    </script>

}