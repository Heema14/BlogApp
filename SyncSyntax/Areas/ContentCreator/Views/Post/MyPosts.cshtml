@model IEnumerable<Post>

@{
    ViewData["Title"] = "MyPosts";
}
<link href="~/css/sidebar.css" rel="stylesheet" />


<!-- Explore Content -->
<section class="col-12 col-md-9 col-lg-10 explore-grid">

    <!-- Create Post Button -->
    <div class="text-end mb-4">
        <a asp-action="Create" class="button create-post-btn">
            <i class="bi bi-plus-circle svgIcon"></i>
        </a>
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        @foreach (var post in Model)
        {
            <div class="col">

                <div class="card h-100 border-0 shadow-lg rounded-4 overflow-hidden">

                    <!-- Post Image -->
                    <div class="overflow-hidden position-relative" style="height: 220px;">
                        <img src="@(!string.IsNullOrEmpty(post.FeatureImagePath) ? post.FeatureImagePath : "/images/uploadImgs/default-image.jpg")"
                             class="card-img-top h-100 w-100 object-fit-cover transition"
                             alt="@post.Title"
                             style="transition: transform 0.3s ease;" />

                        <!-- Overlay -->
                        <a asp-action="Detail" asp-controller="Post" asp-area="ContentCreator" asp-route-id="@post.Id" class="read-more-overlay d-flex justify-content-center align-items-center text-white text-decoration-none">
                            <span class="fs-6 fw-semibold"><i class="bi bi-book me-2"></i>Read More</span>
                        </a>
                    </div>

                    <div class="card-body">
                        <!-- User Info (Above Title) -->
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <span>
                                    <img src="@post.UserImageUrl" alt="User" class="rounded-circle" style="width: 30px; height: 30px;">
                                </span>
                                <span>@post.UserName</span>
                            </div>

                            <div class="d-flex align-items-center gap-2 actions">
                                <span class="text-danger" onclick="confirmDelete(@post.Id)"><i class="bi bi-trash3-fill"></i></span>
                                <span onclick="location.href='@Url.Action("Edit", "Post", new { id = post.Id })'">
                                    <i class="bi bi-pencil-square"></i>
                                </span>
                            </div>
                        </div>

                        <!-- Post Title and Likes -->
                        <div class="d-flex align-items-center gap-2 like-btn"
                             data-postid="@post.Id"
                             style="cursor:pointer;">
                            <i id="likeIcon-@post.Id" class="bi bi-heart-fill"
                               style="color:@(post.PostLikes.Any(l => l.UserId == User.FindFirstValue(ClaimTypes.NameIdentifier)) ? "red" : "gray");">
                            </i>
                            <span id="likesCount-@post.Id">@post.LikesCount</span>
                        </div>

                        <p class="text-muted mb-2 DatePost">
                            <i class="bi bi-calendar-event me-1"></i>
                            @post.PublishedDate.ToString("MMMM dd, yyyy")
                        </p>

                        @{
                            var contentTag = HtmlTagHelper.RemoveHtmlTags(post.Content);
                            var preview = contentTag.Length > 100 ? contentTag.Substring(0, 100) + "..." : contentTag;
                        }

                        <p class="card-text text-black">@preview</p>

                        @if (post.Category != null)
                        {
                            <span class="badge bg-info text-dark mt-2">
                                <i class="bi bi-tag me-1"></i> @post.Category.Name
                            </span>
                        }
                    </div>

                </div>

            </div>
        }
    </div>
</section>

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
    <script>
            <script>
        // تهيئة SignalR لكل بوست
        $(document).ready(function () {
            $('.like-btn').each(function () {
                var postId = $(this).data('postid');
                setupPostLikeHub(postId);
            });
        });

        function setupPostLikeHub(postId) {
            var connection = new signalR.HubConnectionBuilder()
                .withUrl("/postLikeHub") // رابط Hub
                .build();

            // استقبال التحديثات من السيرفر
            connection.on("ReceiveLike", function (postId, likesCount) {
                $('#likesCount-' + postId).text(likesCount);
            });

            connection.start()
                .then(function () {
                    connection.invoke("JoinGroup", postId)
                        .catch(err => console.error(err.toString()));
                })
                .catch(err => console.error(err.toString()));

            // تخزين الاتصال في العنصر حتى يمكن إعادة استخدامه إذا أردت لاحقًا
            $(`.like-btn[data-postid='${postId}']`).data('connection', connection);
        }

        // دالة تغيير حالة اللايك
        $('.like-btn').click(function () {
            var postId = $(this).data('postid');
            $.ajax({
                url: '/Post/Like',
                type: 'POST',
                data: { postId: postId },
                success: function (response) {
                    if (response.success) {
                        $('#likesCount-' + postId).text(response.likesCount);
                        $('#likeIcon-' + postId).css('color', response.userLiked ? 'red' : 'gray');
                    } else {
                        alert(response.message);
                    }
                },
                error: function () {
                    alert('حدث خطأ أثناء تنفيذ الطلب.');
                }
            });
        });

    </script>
}